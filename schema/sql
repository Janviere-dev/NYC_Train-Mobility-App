-- Locations Table (Dimension)
CREATE TABLE locations (
    location_id SERIAL PRIMARY KEY,
    latitude DECIMAL(10, 8) NOT NULL,
    longitude DECIMAL(11, 8) NOT NULL,
    zone_name VARCHAR(100),
    borough VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Time Dimension Table
CREATE TABLE time_dim (
    time_id SERIAL PRIMARY KEY,
    date DATE NOT NULL,
    hour INT NOT NULL,
    day_of_week INT NOT NULL,
    week_of_year INT NOT NULL,
    month INT NOT NULL,
    quarter INT NOT NULL,
    year INT NOT NULL,
    is_weekend BOOLEAN NOT NULL,
    UNIQUE(date, hour)
);

-- Payment Types Table
CREATE TABLE payment_types (
    payment_type_id SERIAL PRIMARY KEY,
    payment_method VARCHAR(50) NOT NULL UNIQUE,
    description TEXT
);

-- Trips Table (Fact Table)
CREATE TABLE trips (
    trip_id SERIAL PRIMARY KEY,
    pickup_datetime TIMESTAMP NOT NULL,
    dropoff_datetime TIMESTAMP NOT NULL,
    pickup_location_id INT REFERENCES locations(location_id),
    dropoff_location_id INT REFERENCES locations(location_id),
    pickup_time_id INT REFERENCES time_dim(time_id),
    dropoff_time_id INT REFERENCES time_dim(time_id),
    passenger_count INT,
    trip_distance DECIMAL(10, 2),
    trip_duration INT, -- in seconds
    fare_amount DECIMAL(10, 2),
    tip_amount DECIMAL(10, 2),
    total_amount DECIMAL(10, 2),
    payment_type_id INT REFERENCES payment_types(payment_type_id),
    -- Derived features
    trip_speed DECIMAL(10, 2), -- km/h or mph
    fare_per_km DECIMAL(10, 2),
    tip_percentage DECIMAL(5, 2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for efficient querying
CREATE INDEX idx_trips_pickup_datetime ON trips(pickup_datetime);
CREATE INDEX idx_trips_dropoff_datetime ON trips(dropoff_datetime);
CREATE INDEX idx_trips_pickup_location ON trips(pickup_location_id);
CREATE INDEX idx_trips_dropoff_location ON trips(dropoff_location_id);
CREATE INDEX idx_trips_distance ON trips(trip_distance);
CREATE INDEX idx_trips_fare ON trips(fare_amount);
CREATE INDEX idx_locations_coords ON locations(latitude, longitude);
CREATE INDEX idx_time_dim_date ON time_dim(date);
